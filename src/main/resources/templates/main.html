<!DOCTYPE html>
<html>
<html lang="en">
<head>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>

<input type="hidden" id="nickName" value="">
<input type="hidden" id="userNum" value="">

<button id="update" onclick="updateGame()">전적갱신</button>
<div id="allGameInfo">
</div>

<hr>

<h2>스트리머 등록</h2>
<form action="/main" method="get">
    블서 닉네임:<input name="erNickname" id="erNickname">
    <button type="submit" onclick="regStreamer()">제출</button>
</form>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="text/javascript"></script>
</body>
</html>

<script>

    let query = window.location.search;
    let param = new URLSearchParams(query);
    let nickname1 = param.get('nickname');

    window.onload = async function getUser() {

        let userResponse = await axios.get("/getUser?nickname=" + nickname1);
        console.log(userResponse);
        let nickName = userResponse.data.nickName;
        let userNum = userResponse.data.userNum;

        document.querySelector("#nickName").value = nickName;
        document.querySelector("#userNum").value = userNum;

        let gameInfoResponse = await axios.get("/getGames?nickName=" + nickName + "&userNum=" + userNum);
        console.log(gameInfoResponse);

        let gameList = gameInfoResponse.data;
        gameList.forEach(function (element){

            const gameInfoDiv = createTag('div', 'gameInfoId' + element.gameId, 'gameInfoClass');

            append("#allGameInfo", gameInfoDiv)

            let playerInfos = element.playerInfos;
            playerInfos.forEach(function (player){

                const playerIdentifyStr =  player.userNum + element.gameId;

                const playerDiv = createTag('div',  'player' +playerIdentifyStr, 'playerClass');
                const playerNickNameDiv =  createTag('div',  'nickName' +playerIdentifyStr, 'playerNickNameClass');
                const playerCharacterNumDiv = createTag('div', 'characterNum' +playerIdentifyStr, 'playerCharacterNumClass');

                append("#gameInfoId" + element.gameId, playerDiv);
                append("#player" +playerIdentifyStr, playerNickNameDiv);
                append("#player" +playerIdentifyStr, playerCharacterNumDiv);

                document.querySelector("#nickName" + playerIdentifyStr).innerHTML = player.nickName;  //id지정자를 생각좀 해봐야 할듯. ) player0,player1...이게 계속 겹침
                document.querySelector("#characterNum" +playerIdentifyStr).innerHTML = player.characterNum;
            });

        });

    }

    async function updateGame() {
        let nickname = document.querySelector("#nickName").value;
        let userNum = document.querySelector("#userNum").value;
        let userResponse = await axios.post("/updateGames?nickname=" + nickname + "&userNum=" + userNum);
    }

    async function regStreamer() {
        let erNickname = document.querySelector("#erNickname").value;
        if (await axios.get("/getStreamer?nickname=" + erNickname)){
            alert("이미 존재하는 스트리머입니다");
        } else {
            await axios.post("/updateStreamer?nickname=" + erNickname);
        }
        let userResponse = await axios.get("/getStreamer?nickname=" + erNickname);
    }




    function createTag(tagType, id, className){
        let div = document.createElement(tagType);
        if(id){
            div.id = id;
        }
        if(className){
            div.className = className;
        }
        return div;
    }

    function append(targetTag, appendTag){
        document.querySelector(targetTag).appendChild(appendTag);
    }





</script>
